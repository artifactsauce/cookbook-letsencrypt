#!/usr/bin/env bash

set -eu

die() {
    echo "$(date) - [ERROR]" "$@" >&2
    exit 1
}

LETSENCRYPT_REPOSITORY="<%= @repository_path %>"
LETSENCRYPT_HTTP_SERVICE="<%= @http_service_name %>"

cd $LETSENCRYPT_REPOSITORY || die "Directory not founds: ${LETSENCRYPT_REPOSITORY}"

service ${LETSENCRYPT_HTTP_SERVICE} stop

./letsencrypt-auto certonly \
<% node["letsencrypt"]["urls"].each do |url| %>
	           -d "<%= url %>" \
<% end %>
	           --renew-by-default

service ${LETSENCRYPT_HTTP_SERVICE} start
